<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>æ„Ÿæƒ…ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚«ãƒ¡ãƒ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    :root { --primary-bg: #2c3e50; --secondary-bg: #34495e; --accent-color: #f39c12; --text-color: #ecf0f1; --button-color: #3498db; }
    html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; }
    body { background: var(--primary-bg); color: var(--text-color); display: flex; flex-direction: column; }
    #app-container { display: flex; flex-direction: column; height: 100%; width: 100%; max-width: 800px; margin: 0 auto; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚¿ãƒ– */
    header { flex-shrink: 0; }
    #tab-selector { display: flex; width: 100%; background-color: var(--secondary-bg); }
    .tab-button { flex-grow: 1; padding: 15px 0; background: transparent; color: var(--text-color); border: none; font-size: 18px; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-button.active { border-bottom: 3px solid var(--accent-color); font-weight: bold; color: var(--accent-color); }

    /* ãƒ¡ã‚¤ãƒ³: ã‚«ãƒ¡ãƒ© or ã‚¢ãƒ«ãƒãƒ  */
    main { flex-grow: 1; width: 100%; position: relative; overflow-y: auto; }
    .tab-content { display: none; height: 100%; }
    .tab-content.active { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
    
    /* ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ */
    #camera-mode { padding: 10px; box-sizing: border-box; }
    #realtime-display { text-align: center; width: 100%; padding: 5px 0; }
    #realtime-text { font-size: 16px; color: #bdc3c7; }
    #realtime-emoji { font-size: 40px; line-height: 1; height: 45px; }
    #target-info { text-align: center; width: 100%; height: 25px; font-size: 18px; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
    #emotion-selector { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; width: 100%; flex-wrap: wrap; }
    .emotion-button { background-color: var(--button-color); color: white; border: none; border-radius: 20px; padding: 8px 14px; font-size: 14px; cursor: pointer; flex-shrink: 0; }
    .emotion-button.active { background-color: #2980b9; box-shadow: 0 0 10px #2980b9; }
    .emotion-button:disabled { background-color: #555; cursor: not-allowed; }
    #video-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 16px rgba(0,0,0,0.4); flex-grow: 1; display: flex; justify-content: center; align-items: center; }
    #video-container::before { content: ''; display: block; padding-top: calc(3 / 4 * 100%); }
    video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
    canvas { z-index: 10; pointer-events: none; } /* ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã« */

    /* ã‚¢ãƒ«ãƒãƒ ãƒ¢ãƒ¼ãƒ‰ */
    #album-mode { padding: 20px; box-sizing: border-box; }
    #album-gallery { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; }
    .gallery-item { background-color: var(--secondary-bg); border-radius: 10px; overflow: hidden; width: 120px; cursor: pointer; }
    .gallery-item img { width: 100%; height: 90px; object-fit: cover; display: block; }
    .gallery-info { padding: 8px; font-size: 12px; text-align: center; }
    .gallery-info .emotion-label { font-weight: bold; color: var(--accent-color); }
    .no-photos-message { color: #95a5a6; font-size: 18px; text-align: center; width: 100%; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯å¤‰æ›´ãªã— */
    #modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
    #modal-content { display: block; max-width: 90vw; max-height: 80vh; border-radius: 10px; }
    #modal-caption { margin: 10px auto; display: block; width: 80%; text-align: center; color: #ccc; padding: 10px 0; font-size: 16px; }
    #modal-close, #modal-download, #modal-delete { position: absolute; top: 15px; color: #f1f1f1; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
    #modal-close { right: 15px; }
    #modal-download { right: 70px; font-size: 24px; padding-top: 5px;}
    #modal-delete { right: 125px; font-size: 24px; padding-top: 5px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>

<body>
  <div id="app-container">
    <header>
      <div id="tab-selector">
        <button class="tab-button active" data-tab="camera-mode">ğŸ“¸ ã‚«ãƒ¡ãƒ©</button>
        <button class="tab-button" data-tab="album-mode">ğŸ–¼ï¸ ã‚¢ãƒ«ãƒãƒ </button>
      </div>
    </header>

    <main>
      <div id="camera-mode" class="tab-content active">
        <div id="realtime-display">
          <div id="realtime-text">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®š</div>
          <div id="realtime-emoji">ğŸ¤”</div>
        </div>
        <div id="target-info">æ„Ÿæƒ…ã‚’é¸ã‚“ã§æ’®å½±ã—ã‚ˆã†</div>
        <div id="emotion-selector">
          <button class="emotion-button" data-emotion="happy">ğŸ˜Š Happy</button>
          <button class="emotion-button" data-emotion="sad">ğŸ˜” Sad</button>
          <button class="emotion-button" data-emotion="angry">ğŸ˜  Angry</button>
          <button class="emotion-button" data-emotion="surprised">ğŸ˜® Surprised</button>
        </div>
        <div id="video-container">
          <video id="input_video" autoplay muted playsinline></video>
          <canvas id="output_canvas"></canvas>
        </div>
      </div>
      <div id="album-mode" class="tab-content">
        <div id="album-gallery"></div>
      </div>
    </main>
  </div>

  <div id="modal">
    <span id="modal-close">&times;</span>
    <span id="modal-delete">ğŸ—‘ï¸</span>
    <a id="modal-download">â¬‡ï¸</a>
    <img id="modal-content">
    <div id="modal-caption"></div>
  </div>

  <script>
    const video = document.getElementById('input_video');
    const realtimeEmoji = document.getElementById('realtime-emoji');
    const targetInfo = document.getElementById('target-info');
    const emotionSelector = document.getElementById('emotion-selector');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const albumGallery = document.getElementById('album-gallery');
    const modal = document.getElementById('modal'), modalImg = document.getElementById('modal-content'), modalCaption = document.getElementById('modal-caption'), modalClose = document.getElementById('modal-close'), modalDownload = document.getElementById('modal-download'), modalDelete = document.getElementById('modal-delete');
    
    let targetEmotion = null, isCapturing = false, photos = [];
    const emotionPrompts = {"happy": "æœ€é«˜ã®ç¬‘é¡”ã‚’è¦‹ã›ã¦ï¼ ğŸ˜Š", "sad": "æ‚²ã—ã„é¡”ã‚’ã—ã¦â€¦ ğŸ˜”", "angry": "æ€’ã£ãŸé¡”ï¼ ğŸ˜ ", "surprised": "é©šã„ãŸé¡”ã§ï¼ ğŸ˜®"};
    const emotionEmojis = {"neutral": "ğŸ˜", "happy": "ğŸ˜Š", "sad": "ğŸ˜”", "angry": "ğŸ˜ ", "surprised": "ğŸ˜®", "fearful": "ğŸ˜¨", "disgusted": "ğŸ¤¢", "No Face": "ğŸ¤”"};

    // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã‚¢ãƒ«ãƒãƒ æ©Ÿèƒ½ ---
    function loadPhotos() { try { const d = localStorage.getItem('emotionPhotos'); if (d) photos = JSON.parse(d); } catch (e) {} renderAlbum(); }
    function savePhotos() { try { localStorage.setItem('emotionPhotos', JSON.stringify(photos)); } catch (e) {} }
    function renderAlbum() { albumGallery.innerHTML = ''; if (photos.length === 0) { albumGallery.innerHTML = '<p class="no-photos-message">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return; } const f = document.createDocumentFragment(); photos.slice().reverse().forEach((p, i) => { const oi = photos.length - 1 - i; const item = document.createElement('div'); item.className = 'gallery-item'; const img = document.createElement('img'); img.src = p.dataUrl; const info = document.createElement('div'); info.className = 'gallery-info'; info.innerHTML = `<span class="emotion-label">${emotionEmojis[p.emotion]} ${p.emotion}</span><div>${new Date(p.timestamp).toLocaleString([],{dateStyle:'short',timeStyle:'short'})}</div>`; item.append(img, info); item.addEventListener('click', () => openModal(p, oi)); f.appendChild(item); }); albumGallery.appendChild(f); }
    let currentPhotoIndex = null;
    function openModal(p, i) { modal.style.display = 'flex'; modalImg.src = p.dataUrl; modalCaption.innerHTML = `<span class="emotion-label">${emotionEmojis[p.emotion]} ${p.emotion}</span><br>${new Date(p.timestamp).toLocaleString()}`; modalDownload.href = p.dataUrl; modalDownload.download = `photo_${p.emotion}_${new Date(p.timestamp).toISOString()}.jpg`; currentPhotoIndex = i; }
    modalClose.onclick = () => modal.style.display = 'none';
    modalDelete.onclick = () => { if (confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { photos.splice(currentPhotoIndex, 1); savePhotos(); renderAlbum(); modal.style.display = 'none'; } };
    
    // --- 1. ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã¨ã‚«ãƒ¡ãƒ©èµ·å‹• ---
    Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri('./models'), faceapi.nets.faceLandmark68Net.loadFromUri('./models'), faceapi.nets.faceExpressionNet.loadFromUri('./models') ]).then(startVideo).catch(err => { targetInfo.innerText = "ã‚¨ãƒ©ãƒ¼: AIãƒ¢ãƒ‡ãƒ«èª­è¾¼å¤±æ•—"; realtimeEmoji.innerText = "ğŸ“â“"; });
    function startVideo() { targetInfo.innerText = "ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­..."; realtimeEmoji.innerText = "ğŸ“·"; if (video.srcObject) return; navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => video.srcObject = stream).catch(err => { targetInfo.innerText = "ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—"; realtimeEmoji.innerText = "ğŸš«"; }); }
    function stopVideo() { if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; } }

    // --- 2. æ’®å½±ãƒ­ã‚¸ãƒƒã‚¯ ---
    function takePhoto(detectedEmotion) { const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight; const ctx = c.getContext('2d'); ctx.translate(c.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0, c.width, c.height); const d = c.toDataURL('image/jpeg', 0.9); photos.push({ dataUrl: d, emotion: detectedEmotion, timestamp: new Date().toISOString() }); savePhotos(); setTimeout(() => { isCapturing = false; targetEmotion = null; targetInfo.innerText = "æ„Ÿæƒ…ã‚’é¸ã‚“ã§æ’®å½±ã—ã‚ˆã†"; emotionSelector.querySelectorAll('button').forEach(b => { b.disabled = false; b.classList.remove('active'); }); }, 2000); }

    // --- 3. èªè­˜ãƒ«ãƒ¼ãƒ— ---
    video.addEventListener('play', () => {
      const canvas = document.getElementById('output_canvas');
      const displaySize = { width: video.clientWidth, height: video.clientHeight };
      faceapi.matchDimensions(canvas, displaySize);
      targetInfo.innerText = "æ„Ÿæƒ…ã‚’é¸ã‚“ã§æ’®å½±ã—ã‚ˆã†";
      setInterval(async () => {
        if (!video.srcObject) return;
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        
        let currentEmotion = "No Face";
        if (detections && detections.length > 0) {
          let highestEmotion = "neutral", highestValue = 0;
          const expressions = detections[0].expressions;
          for (const e in expressions) { if (expressions[e] > highestValue) { highestValue = expressions[e]; highestEmotion = e; } }
          currentEmotion = highestEmotion;
          
          if (targetEmotion && currentEmotion === targetEmotion && !isCapturing && highestValue > 0.8) {
            isCapturing = true;
            emotionSelector.querySelectorAll('button').forEach(b => b.disabled = true);
            targetInfo.innerText = `ã€Œ${targetEmotion}ã€ã‚’ã‚­ãƒ£ãƒƒãƒï¼`;
            takePhoto(targetEmotion);
          }
        }
        if (!isCapturing) { realtimeEmoji.innerText = emotionEmojis[currentEmotion]; }
      }, 300);
    });

    // --- 4. ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
    emotionSelector.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => {
        if(targetEmotion === button.dataset.emotion) { // åŒã˜ãƒœã‚¿ãƒ³ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤
            targetEmotion = null;
            button.classList.remove('active');
            targetInfo.innerText = "æ„Ÿæƒ…ã‚’é¸ã‚“ã§æ’®å½±ã—ã‚ˆã†";
        } else {
            targetEmotion = button.dataset.emotion;
            targetInfo.innerText = emotionPrompts[targetEmotion];
            emotionSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
      });
    });
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.dataset.tab;
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        tabContents.forEach(content => {
          content.classList.toggle('active', content.id === targetTab);
          if (content.id === 'album-mode' && content.classList.contains('active')) {
            renderAlbum(); stopVideo();
          } else if (content.id === 'camera-mode' && content.classList.contains('active')) {
            startVideo();
          }
        });
      });
    });
    
    // åˆæœŸåŒ–
    loadPhotos();
  </script>
</body>
</html>
