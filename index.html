<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>感情シャッターカメラ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    /* --- 全体のスタイル設定 --- */
    :root {
      --base-bg: #f8f9fa; /* 全体の背景 */
      --content-bg: #ffffff; /* コンテンツエリアの背景 (白) */
      --tab-container-bg: #e9ecef; /* タブコンテナの背景 */
      --text-color: #212529; /* 基本テキスト色 */
      --text-muted-color: #6c757d; /* 薄いテキスト色 */
      --emotion-button-bg: #495057; /* 感情ボタンの背景 */
      --emotion-button-active-bg: #343a40; /* アクティブな感情ボタン */
      --button-text-color: #ffffff; /* ボタンのテキスト色 */
      --accent-color: #0d6efd; /* アクセントカラー (例: Bootstrap Blue) */
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    body {
      background: var(--base-bg);
      color: var(--text-color);
      display: flex;
      justify-content: center;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      max-width: 420px; /* スマートフォン風の幅に固定 */
      margin: 0 auto;
      background: var(--base-bg);
      position: relative;
    }

    /* --- ヘッダー: タブ --- */
    header {
      flex-shrink: 0;
      padding: 15px 15px 10px; /* 上の余白を少し詰める */
    }
    #tab-selector {
      display: flex;
      width: 100%;
      background-color: var(--tab-container-bg);
      border-radius: 25px;
      padding: 4px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    .tab-button {
      flex-grow: 1;
      padding: 10px 0;
      background: transparent;
      color: var(--text-muted-color);
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 22px;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
    }
    .tab-button.active {
      background-color: var(--content-bg);
      color: var(--text-color);
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* --- メインコンテンツ --- */
    main {
      flex-grow: 1;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    .tab-content { display: none; height: 100%; }
    .tab-content.active { display: flex; flex-direction: column; }
    
    /* --- カメラモード --- */
    /* ★★★ 修正点: カメラモード全体をFlexboxコンテナとして設定 ★★★ */
    #camera-mode {
      height: 100%;
      display: flex;
      flex-direction: column;
      text-align: center;
    }
    .camera-ui-top {
      padding: 10px 20px; /* 上下の余白を詰める */
      flex-shrink: 0;
    }
    .instruction-text {
      font-size: 16px;
      color: var(--text-muted-color);
      margin-bottom: 12px; /* 余白を詰める */
    }
    #emotion-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px; /* 余白を詰める */
      width: 100%;
      flex-wrap: wrap; 
    }
    .emotion-button {
      background-color: var(--emotion-button-bg);
      color: var(--button-text-color);
      border: none;
      border-radius: 25px;
      padding: 8px 10px; /* ★★★ 修正点: ボタンの余白を調整 ★★★ */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center; /* テキストと絵文字を中央寄せ */
      gap: 5px;
      transition: all 0.2s;
      flex-shrink: 0; 
      width: calc(33.33% - 10px); /* ★★★ 修正点: 横3列になるように幅を指定 ★★★ */
      box-sizing: border-box;
    }
    .emotion-button.active {
      background-color: var(--emotion-button-active-bg);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(-2px);
    }
    #target-info {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-color);
      height: 22px; /* 高さを詰める */
    }
    #realtime-display { display: none; }

    /* ★★★ 修正点: 下部シートのレイアウト方式を変更 ★★★ */
    .bottom-sheet {
      flex-grow: 1; /* 残りの高さをすべて埋める */
      min-height: 0; /* Flexboxの子要素が縮小できるように */
      background: var(--content-bg);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      box-sizing: border-box;
    }
    .sheet-handle {
      width: 40px;
      height: 5px;
      background-color: #d8d8d8;
      border-radius: 2.5px;
      margin-bottom: 15px;
      flex-shrink: 0;
    }
    #video-container {
      position: relative;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #e9ecef;
    }
    video, canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: cover; transform: scaleX(-1);
    }
    canvas { z-index: 10; pointer-events: none; }

    /* --- アルバムモード --- */
    #album-mode { padding: 20px; box-sizing: border-box; background: var(--content-bg); }
    #album-gallery { display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 15px; width: 100%; }
    .gallery-item {
      background-color: #f1f1f1; border-radius: 10px; overflow: hidden;
      width: calc(50% - 7.5px); cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .gallery-item img { width: 100%; height: 120px; object-fit: cover; display: block; }
    .gallery-info { padding: 8px; font-size: 12px; text-align: center; }
    .gallery-info .emotion-label { font-weight: bold; color: var(--accent-color); }
    .no-photos-message { color: var(--text-muted-color); font-size: 18px; text-align: center; width: 100%; padding-top: 40px; }

    /* --- モーダル (変更なし) --- */
    #modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
    #modal-content { display: block; max-width: 90vw; max-height: 80vh; border-radius: 10px; }
    #modal-caption { margin: 10px auto; display: block; width: 80%; text-align: center; color: #ccc; padding: 10px 0; font-size: 16px; }
    #modal-close, #modal-download, #modal-delete { position: absolute; top: 15px; color: #f1f1f1; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
    #modal-close { right: 15px; }
    #modal-download { right: 70px; font-size: 24px; padding-top: 5px;}
    #modal-delete { right: 125px; font-size: 24px; padding-top: 5px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>

<body>
  <div id="app-container">
    <header>
      <div id="tab-selector">
        <button class="tab-button active" data-tab="camera-mode">カメラ</button>
        <button class="tab-button" data-tab="album-mode">ギャラリー</button>
      </div>
    </header>

    <main>
      <div id="camera-mode" class="tab-content active">
        <div class="camera-ui-top">
            <p class="instruction-text">感情を選んで撮影しよう</p>
            <div id="emotion-selector">
              <button class="emotion-button" data-emotion="happy">😀 Happy</button>
              <button class="emotion-button" data-emotion="sad">😢 Sad</button>
              <button class="emotion-button" data-emotion="surprised">😲 Surprised</button>
              <button class="emotion-button" data-emotion="angry">😠 Angry</button>
              <button class="emotion-button" data-emotion="disgusted">🤢 Disgusted</button>
              <button class="emotion-button" data-emotion="neutral">😐 Neutral</button>
            </div>
            <div id="target-info"></div>
            <div id="realtime-display">
                <div id="realtime-text">リアルタイム判定</div>
                <div id="realtime-emoji">🤔</div>
            </div>
        </div>

        <div class="bottom-sheet">
            <div class="sheet-handle"></div>
            <div id="video-container">
                <video id="input_video" autoplay muted playsinline></video>
                <canvas id="output_canvas"></canvas>
            </div>
        </div>
      </div>

      <div id="album-mode" class="tab-content">
        <div id="album-gallery"></div>
      </div>
    </main>
  </div>

  <div id="modal">
    <span id="modal-close">&times;</span>
    <span id="modal-delete">🗑️</span>
    <a id="modal-download">⬇️</a>
    <img id="modal-content">
    <div id="modal-caption"></div>
  </div>

  <script>
    const video = document.getElementById('input_video');
    const realtimeEmoji = document.getElementById('realtime-emoji');
    const targetInfo = document.getElementById('target-info');
    const emotionSelector = document.getElementById('emotion-selector');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const albumGallery = document.getElementById('album-gallery');
    const modal = document.getElementById('modal'), modalImg = document.getElementById('modal-content'), modalCaption = document.getElementById('modal-caption'), modalClose = document.getElementById('modal-close'), modalDownload = document.getElementById('modal-download'), modalDelete = document.getElementById('modal-delete');
    
    let targetEmotion = null, isCapturing = false, photos = [];
    const emotionPrompts = {
        "happy": "最高の笑顔で！ 😄", 
        "sad": "悲しい顔をして… 😔", 
        "angry": "怒った顔！ 😠", 
        "surprised": "驚いた顔で！ 😮",
        "disgusted": "嫌悪の表情で… 🤢",
        "neutral": "無表情で。 😐"
    };
    const emotionEmojis = {"neutral": "😐", "happy": "😊", "sad": "😔", "angry": "😠", "surprised": "😮", "fearful": "😨", "disgusted": "🤢", "No Face": "🤔"};

    // --- ローカルストレージとアルバム機能 ---
    function loadPhotos() { try { const d = localStorage.getItem('emotionPhotos'); if (d) photos = JSON.parse(d); } catch (e) {} renderAlbum(); }
    function savePhotos() { try { localStorage.setItem('emotionPhotos', JSON.stringify(photos)); } catch (e) {} }
    function renderAlbum() { albumGallery.innerHTML = ''; if (photos.length === 0) { albumGallery.innerHTML = '<p class="no-photos-message">まだ写真がありません。</p>'; return; } const f = document.createDocumentFragment(); photos.slice().reverse().forEach((p, i) => { const oi = photos.length - 1 - i; const item = document.createElement('div'); item.className = 'gallery-item'; const img = document.createElement('img'); img.src = p.dataUrl; const info = document.createElement('div'); info.className = 'gallery-info'; info.innerHTML = `<span class="emotion-label">${emotionEmojis[p.emotion]} ${p.emotion}</span><div>${new Date(p.timestamp).toLocaleString([],{dateStyle:'short',timeStyle:'short'})}</div>`; item.append(img, info); item.addEventListener('click', () => openModal(p, oi)); f.appendChild(item); }); albumGallery.appendChild(f); }
    let currentPhotoIndex = null;
    function openModal(p, i) { modal.style.display = 'flex'; modalImg.src = p.dataUrl; modalCaption.innerHTML = `<span class="emotion-label">${emotionEmojis[p.emotion]} ${p.emotion}</span><br>${new Date(p.timestamp).toLocaleString()}`; modalDownload.href = p.dataUrl; modalDownload.download = `photo_${p.emotion}_${new Date(p.timestamp).toISOString()}.jpg`; currentPhotoIndex = i; }
    modalClose.onclick = () => modal.style.display = 'none';
    modalDelete.onclick = () => { if (confirm('この写真を削除しますか？')) { photos.splice(currentPhotoIndex, 1); savePhotos(); renderAlbum(); modal.style.display = 'none'; } };
    
    // --- 1. モデル読み込みとカメラ起動 ---
    Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri('./models'), faceapi.nets.faceLandmark68Net.loadFromUri('./models'), faceapi.nets.faceExpressionNet.loadFromUri('./models') ]).then(startVideo).catch(err => { targetInfo.innerText = "エラー: AIモデル読込失敗"; });
    function startVideo() { targetInfo.innerText = "カメラにアクセス中...📷"; if (video.srcObject) return; navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => { video.srcObject = stream; targetInfo.innerText = ""; }).catch(err => { targetInfo.innerText = "エラー: カメラ起動失敗🚫"; }); }
    function stopVideo() { if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; } }

    // --- 2. 撮影ロジック ---
    function takePhoto(detectedEmotion) { const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight; const ctx = c.getContext('2d'); ctx.translate(c.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0, c.width, c.height); const d = c.toDataURL('image/jpeg', 0.9); photos.push({ dataUrl: d, emotion: detectedEmotion, timestamp: new Date().toISOString() }); savePhotos(); setTimeout(() => { isCapturing = false; targetEmotion = null; targetInfo.innerText = "撮影しました！✅"; setTimeout(() => { targetInfo.innerText = ""; }, 2000); emotionSelector.querySelectorAll('button').forEach(b => { b.disabled = false; b.classList.remove('active'); }); }, 2000); }

    // --- 3. 認識ループ ---
    video.addEventListener('play', () => {
      const canvas = document.getElementById('output_canvas');
      const displaySize = { width: video.clientWidth, height: video.clientHeight };
      faceapi.matchDimensions(canvas, displaySize);
      
      setInterval(async () => {
        if (!video.srcObject) return;
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        
        let currentEmotion = "No Face";
        if (detections && detections.length > 0) {
          let highestEmotion = "neutral", highestValue = 0;
          const expressions = detections[0].expressions;
          for (const e in expressions) { if (expressions[e] > highestValue) { highestValue = expressions[e]; highestEmotion = e; } }
          currentEmotion = highestEmotion;
          
          if (targetEmotion && currentEmotion === targetEmotion && !isCapturing && highestValue > 0.8) {
            isCapturing = true;
            emotionSelector.querySelectorAll('button').forEach(b => b.disabled = true);
            targetInfo.innerText = `「${targetEmotion}」をキャッチ！`;
            takePhoto(targetEmotion);
          }
        }
        if (!isCapturing) { realtimeEmoji.innerText = emotionEmojis[currentEmotion]; }
      }, 300);
    });

    // --- 4. イベント設定 ---
    emotionSelector.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => {
        if(targetEmotion === button.dataset.emotion) { // 同じボタンを再度クリックで解除
            targetEmotion = null;
            button.classList.remove('active');
            targetInfo.innerText = "";
        } else {
            targetEmotion = button.dataset.emotion;
            targetInfo.innerText = emotionPrompts[targetEmotion];
            emotionSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
      });
    });
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.dataset.tab;
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        tabContents.forEach(content => {
          content.classList.toggle('active', content.id === targetTab);
          if (content.id === 'album-mode' && content.classList.contains('active')) {
            renderAlbum(); stopVideo();
          } else if (content.id === 'camera-mode' && content.classList.contains('active')) {
            startVideo();
          }
        });
      });
    });
    
    // 初期化
    loadPhotos();
  </script>
</body>
</html>
