<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>æ„Ÿæƒ…ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚«ãƒ¡ãƒ©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    /* --- å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š --- */
    :root {
      --base-bg: #f8f9fa; /* å…¨ä½“ã®èƒŒæ™¯ */
      --content-bg: #ffffff; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã®èƒŒæ™¯ (ç™½) */
      --tab-container-bg: #e9ecef; /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠã®èƒŒæ™¯ */
      --text-color: #212529; /* åŸºæœ¬ãƒ†ã‚­ã‚¹ãƒˆè‰² */
      --text-muted-color: #6c757d; /* è–„ã„ãƒ†ã‚­ã‚¹ãƒˆè‰² */
      --emotion-button-bg: #495057; /* æ„Ÿæƒ…ãƒœã‚¿ãƒ³ã®èƒŒæ™¯ */
      --emotion-button-active-bg: #343a40; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ„Ÿæƒ…ãƒœã‚¿ãƒ³ */
      --button-text-color: #ffffff; /* ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆè‰² */
      --accent-color: #0d6efd; /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã‚«ãƒ©ãƒ¼ (ä¾‹: Bootstrap Blue) */
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    body {
      background: var(--base-bg);
      color: var(--text-color);
      display: flex;
      justify-content: center;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      max-width: 420px; /* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³é¢¨ã®å¹…ã«å›ºå®š */
      margin: 0 auto;
      background: var(--base-bg);
      position: relative;
    }

    /* --- ãƒ˜ãƒƒãƒ€ãƒ¼: ã‚¿ãƒ– --- */
    header {
      flex-shrink: 0;
      padding: 15px 15px 10px; /* ä¸Šã®ä½™ç™½ã‚’å°‘ã—è©°ã‚ã‚‹ */
    }
    #tab-selector {
      display: flex;
      width: 100%;
      background-color: var(--tab-container-bg);
      border-radius: 25px;
      padding: 4px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    .tab-button {
      flex-grow: 1;
      padding: 10px 0;
      background: transparent;
      color: var(--text-muted-color);
      border: none;
      font-size: 16px;
      cursor: pointer;
      border-radius: 22px;
      font-weight: 500;
      transition: all 0.2s ease-in-out;
    }
    .tab-button.active {
      background-color: var(--content-bg);
      color: var(--text-color);
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
    main {
      flex-grow: 1;
      width: 100%;
      position: relative;
      overflow: hidden;
    }
    .tab-content { display: none; height: 100%; }
    .tab-content.active { display: flex; flex-direction: column; }
    
    /* --- ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰ --- */
    /* â˜…â˜…â˜… ä¿®æ­£ç‚¹: ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰å…¨ä½“ã‚’Flexboxã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦è¨­å®š â˜…â˜…â˜… */
    #camera-mode {
      height: 100%;
      display: flex;
      flex-direction: column;
      text-align: center;
    }
    .camera-ui-top {
      padding: 10px 20px; /* ä¸Šä¸‹ã®ä½™ç™½ã‚’è©°ã‚ã‚‹ */
      flex-shrink: 0;
    }
    .instruction-text {
      font-size: 16px;
      color: var(--text-muted-color);
      margin-bottom: 12px; /* ä½™ç™½ã‚’è©°ã‚ã‚‹ */
    }
    #emotion-selector {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 12px; /* ä½™ç™½ã‚’è©°ã‚ã‚‹ */
      width: 100%;
      flex-wrap: wrap; 
    }
    .emotion-button {
      background-color: var(--emotion-button-bg);
      color: var(--button-text-color);
      border: none;
      border-radius: 25px;
      padding: 8px 10px; /* â˜…â˜…â˜… ä¿®æ­£ç‚¹: ãƒœã‚¿ãƒ³ã®ä½™ç™½ã‚’èª¿æ•´ â˜…â˜…â˜… */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center; /* ãƒ†ã‚­ã‚¹ãƒˆã¨çµµæ–‡å­—ã‚’ä¸­å¤®å¯„ã› */
      gap: 5px;
      transition: all 0.2s;
      flex-shrink: 0; 
      width: calc(33.33% - 10px); /* â˜…â˜…â˜… ä¿®æ­£ç‚¹: æ¨ª3åˆ—ã«ãªã‚‹ã‚ˆã†ã«å¹…ã‚’æŒ‡å®š â˜…â˜…â˜… */
      box-sizing: border-box;
    }
    .emotion-button.active {
      background-color: var(--emotion-button-active-bg);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transform: translateY(-2px);
    }
    #target-info {
      font-size: 18px;
      font-weight: bold;
      color: var(--text-color);
      height: 22px; /* é«˜ã•ã‚’è©°ã‚ã‚‹ */
    }
    #realtime-display { display: none; }

    /* â˜…â˜…â˜… ä¿®æ­£ç‚¹: ä¸‹éƒ¨ã‚·ãƒ¼ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ–¹å¼ã‚’å¤‰æ›´ â˜…â˜…â˜… */
    .bottom-sheet {
      flex-grow: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’ã™ã¹ã¦åŸ‹ã‚ã‚‹ */
      min-height: 0; /* Flexboxã®å­è¦ç´ ãŒç¸®å°ã§ãã‚‹ã‚ˆã†ã« */
      background: var(--content-bg);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px;
      box-sizing: border-box;
    }
    .sheet-handle {
      width: 40px;
      height: 5px;
      background-color: #d8d8d8;
      border-radius: 2.5px;
      margin-bottom: 15px;
      flex-shrink: 0;
    }
    #video-container {
      position: relative;
      width: 100%;
      border-radius: 15px;
      overflow: hidden;
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #e9ecef;
    }
    video, canvas {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: cover; transform: scaleX(-1);
    }
    canvas { z-index: 10; pointer-events: none; }

    /* --- ã‚¢ãƒ«ãƒãƒ ãƒ¢ãƒ¼ãƒ‰ --- */
    #album-mode { padding: 20px; box-sizing: border-box; background: var(--content-bg); }
    #album-gallery { display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 15px; width: 100%; }
    .gallery-item {
      background-color: #f1f1f1; border-radius: 10px; overflow: hidden;
      width: calc(50% - 7.5px); cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .gallery-item img { width: 100%; height: 120px; object-fit: cover; display: block; }
    .gallery-info { padding: 8px; font-size: 12px; text-align: center; }
    .gallery-info .emotion-label { font-weight: bold; color: var(--accent-color); }
    .no-photos-message { color: var(--text-muted-color); font-size: 18px; text-align: center; width: 100%; padding-top: 40px; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (å¤‰æ›´ãªã—) --- */
    #modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); justify-content: center; align-items: center; }
    #modal-content { display: block; max-width: 90vw; max-height: 80vh; border-radius: 10px; }
    #modal-caption { margin: 10px auto; display: block; width: 80%; text-align: center; color: #ccc; padding: 10px 0; font-size: 16px; }
    #modal-close, #modal-download, #modal-delete { position: absolute; top: 15px; color: #f1f1f1; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
    #modal-close { right: 15px; }
    #modal-download { right: 70px; font-size: 24px; padding-top: 5px;}
    #modal-delete { right: 125px; font-size: 24px; padding-top: 5px;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>

<body>
  <div id="app-container">
    <header>
      <div id="tab-selector">
        <button class="tab-button active" data-tab="camera-mode">ã‚«ãƒ¡ãƒ©</button>
        <button class="tab-button" data-tab="album-mode">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</button>
      </div>
    </header>

    <main>
      <div id="camera-mode" class="tab-content active">
        <div class="camera-ui-top">
            <p class="instruction-text">æ„Ÿæƒ…ã‚’é¸ã‚“ã§æ’®å½±ã—ã‚ˆã†</p>
            <div id="emotion-selector">
              <button class="emotion-button" data-emotion="happy">ğŸ˜€ Happy</button>
              <button class="emotion-button" data-emotion="sad">ğŸ˜¢ Sad</button>
              <button class="emotion-button" data-emotion="surprised">ğŸ˜² Surprised</button>
              <button class="emotion-button" data-emotion="angry">ğŸ˜  Angry</button>
              <button class="emotion-button" data-emotion="disgusted">ğŸ¤¢ Disgusted</button>
              <button class="emotion-button" data-emotion="neutral">ğŸ˜ Neutral</button>
            </div>
            <div id="target-info"></div>
            <div id="realtime-display">
                <div id="realtime-text">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¤å®š</div>
                <div id="realtime-emoji">ğŸ¤”</div>
            </div>
        </div>

        <div class="bottom-sheet">
            <div class="sheet-handle"></div>
            <div id="video-container">
                <video id="input_video" autoplay muted playsinline></video>
                <canvas id="output_canvas"></canvas>
            </div>
        </div>
      </div>

      <div id="album-mode" class="tab-content">
        <div id="album-gallery"></div>
      </div>
    </main>
  </div>

  <div id="modal">
    <span id="modal-close">&times;</span>
    <span id="modal-delete">ğŸ—‘ï¸</span>
    <a id="modal-download">â¬‡ï¸</a>
    <img id="modal-content">
    <div id="modal-caption"></div>
  </div>

  <script>
    const video = document.getElementById('input_video');
    const realtimeEmoji = document.getElementById('realtime-emoji');
    const targetInfo = document.getElementById('target-info');
    const emotionSelector = document.getElementById('emotion-selector');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    const albumGallery = document.getElementById('album-gallery');
    const modal = document.getElementById('modal'), modalImg = document.getElementById('modal-content'), modalCaption = document.getElementById('modal-caption'), modalClose = document.getElementById('modal-close'), modalDownload = document.getElementById('modal-download'), modalDelete = document.getElementById('modal-delete');
    
    let targetEmotion = null, isCapturing = false, photos = [];
    const emotionPrompts = {
        "happy": "æœ€é«˜ã®ç¬‘é¡”ã§ï¼ ğŸ˜„", 
        "sad": "æ‚²ã—ã„é¡”ã‚’ã—ã¦â€¦ ğŸ˜”", 
        "angry": "æ€’ã£ãŸé¡”ï¼ ğŸ˜ ", 
        "surprised": "é©šã„ãŸé¡”ã§ï¼ ğŸ˜®",
        "disgusted": "å«Œæ‚ªã®è¡¨æƒ…ã§â€¦ ğŸ¤¢",
        "neutral": "ç„¡è¡¨æƒ…ã§ã€‚ ğŸ˜"
    };
    const emotionEmojis = {"neutral": "ğŸ˜", "happy": "ğŸ˜Š", "sad": "ğŸ˜”", "angry": "ğŸ˜ ", "surprised": "ğŸ˜®", "fearful": "ğŸ˜¨", "disgusted": "ğŸ¤¢", "No Face": "ğŸ¤”"};

    // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã‚¢ãƒ«ãƒãƒ æ©Ÿèƒ½ ---
    function loadPhotos() { try { const d = localStorage.getItem('emotionPhotos'); if (d) photos = JSON.parse(d); } catch (e) {} renderAlbum(); }
    function savePhotos() { try { localStorage.setItem('emotionPhotos', JSON.stringify(photos)); } catch (e) {} }
    function renderAlbum() { albumGallery.innerHTML = ''; if (photos.length === 0) { albumGallery.innerHTML = '<p class="no-photos-message">ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return; } const f = document.createDocumentFragment(); photos.slice().reverse().forEach((p, i) => { const oi = photos.length - 1 - i; const item = document.createElement('div'); item.className = 'gallery-item'; const img = document.createElement('img'); img.src = p.dataUrl; const info = document.createElement('div'); info.className = 'gallery-info'; info.innerHTML = `<span class="emotion-label">${emotionEmojis[p.emotion]} ${p.emotion}</span><div>${new Date(p.timestamp).toLocaleString([],{dateStyle:'short',timeStyle:'short'})}</div>`; item.append(img, info); item.addEventListener('click', () => openModal(p, oi)); f.appendChild(item); }); albumGallery.appendChild(f); }
    let currentPhotoIndex = null;
    function openModal(p, i) { modal.style.display = 'flex'; modalImg.src = p.dataUrl; modalCaption.innerHTML = `<span class="emotion-label">${emotionEmojis[p.emotion]} ${p.emotion}</span><br>${new Date(p.timestamp).toLocaleString()}`; modalDownload.href = p.dataUrl; modalDownload.download = `photo_${p.emotion}_${new Date(p.timestamp).toISOString()}.jpg`; currentPhotoIndex = i; }
    modalClose.onclick = () => modal.style.display = 'none';
    modalDelete.onclick = () => { if (confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { photos.splice(currentPhotoIndex, 1); savePhotos(); renderAlbum(); modal.style.display = 'none'; } };
    
    // --- 1. ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã¨ã‚«ãƒ¡ãƒ©èµ·å‹• ---
    Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri('./models'), faceapi.nets.faceLandmark68Net.loadFromUri('./models'), faceapi.nets.faceExpressionNet.loadFromUri('./models') ]).then(startVideo).catch(err => { targetInfo.innerText = "ã‚¨ãƒ©ãƒ¼: AIãƒ¢ãƒ‡ãƒ«èª­è¾¼å¤±æ•—"; });
    function startVideo() { targetInfo.innerText = "ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...ğŸ“·"; if (video.srcObject) return; navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => { video.srcObject = stream; targetInfo.innerText = ""; }).catch(err => { targetInfo.innerText = "ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—ğŸš«"; }); }
    function stopVideo() { if (video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; } }

    // --- 2. æ’®å½±ãƒ­ã‚¸ãƒƒã‚¯ ---
    function takePhoto(detectedEmotion) { const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight; const ctx = c.getContext('2d'); ctx.translate(c.width, 0); ctx.scale(-1, 1); ctx.drawImage(video, 0, 0, c.width, c.height); const d = c.toDataURL('image/jpeg', 0.9); photos.push({ dataUrl: d, emotion: detectedEmotion, timestamp: new Date().toISOString() }); savePhotos(); setTimeout(() => { isCapturing = false; targetEmotion = null; targetInfo.innerText = "æ’®å½±ã—ã¾ã—ãŸï¼âœ…"; setTimeout(() => { targetInfo.innerText = ""; }, 2000); emotionSelector.querySelectorAll('button').forEach(b => { b.disabled = false; b.classList.remove('active'); }); }, 2000); }

    // --- 3. èªè­˜ãƒ«ãƒ¼ãƒ— ---
    video.addEventListener('play', () => {
      const canvas = document.getElementById('output_canvas');
      const displaySize = { width: video.clientWidth, height: video.clientHeight };
      faceapi.matchDimensions(canvas, displaySize);
      
      setInterval(async () => {
        if (!video.srcObject) return;
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
        canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        
        let currentEmotion = "No Face";
        if (detections && detections.length > 0) {
          let highestEmotion = "neutral", highestValue = 0;
          const expressions = detections[0].expressions;
          for (const e in expressions) { if (expressions[e] > highestValue) { highestValue = expressions[e]; highestEmotion = e; } }
          currentEmotion = highestEmotion;
          
          if (targetEmotion && currentEmotion === targetEmotion && !isCapturing && highestValue > 0.8) {
            isCapturing = true;
            emotionSelector.querySelectorAll('button').forEach(b => b.disabled = true);
            targetInfo.innerText = `ã€Œ${targetEmotion}ã€ã‚’ã‚­ãƒ£ãƒƒãƒï¼`;
            takePhoto(targetEmotion);
          }
        }
        if (!isCapturing) { realtimeEmoji.innerText = emotionEmojis[currentEmotion]; }
      }, 300);
    });

    // --- 4. ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
    emotionSelector.querySelectorAll('button').forEach(button => {
      button.addEventListener('click', () => {
        if(targetEmotion === button.dataset.emotion) { // åŒã˜ãƒœã‚¿ãƒ³ã‚’å†åº¦ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤
            targetEmotion = null;
            button.classList.remove('active');
            targetInfo.innerText = "";
        } else {
            targetEmotion = button.dataset.emotion;
            targetInfo.innerText = emotionPrompts[targetEmotion];
            emotionSelector.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }
      });
    });
    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.dataset.tab;
        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        tabContents.forEach(content => {
          content.classList.toggle('active', content.id === targetTab);
          if (content.id === 'album-mode' && content.classList.contains('active')) {
            renderAlbum(); stopVideo();
          } else if (content.id === 'camera-mode' && content.classList.contains('active')) {
            startVideo();
          }
        });
      });
    });
    
    // åˆæœŸåŒ–
    loadPhotos();
  </script>
</body>
</html>
